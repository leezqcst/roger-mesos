{%- raw -%}
# Template rendered at {{ getTime }}
global
        log /dev/log    local0
        log /dev/log    local1 notice
        chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode 660 level admin
        stats timeout 30s
        user haproxy
        group haproxy
        daemon

        # Default SSL material locations
        ca-base /etc/ssl/certs
        crt-base /etc/ssl/private

        # Default ciphers to use on SSL-enabled listening sockets.
        # For more information, see ciphers(1SSL).
        # ssl-default-bind-ciphers kEECDH+aRSA+AES:kRSA+AES:+AES256:RC4-SHA:!kEDH:!LOW:!EXP:!MD5:!aNULL:!eNULL

defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        timeout connect 5000
        timeout client  50000
        timeout server  50000

        errorfile 400 /etc/haproxy/errors/400.http
        errorfile 403 /etc/haproxy/errors/403.http
        errorfile 408 /etc/haproxy/errors/408.http
        errorfile 500 /etc/haproxy/errors/500.http
        errorfile 502 /etc/haproxy/errors/502.http
        errorfile 503 /etc/haproxy/errors/503.http
        errorfile 504 /etc/haproxy/errors/504.http

# Template Customization
frontend http-in
        bind *:80

        acl host_mesos hdr_beg(host) -i mesos.
        use_backend mesos if host_mesos

        acl host_marathon hdr_beg(host) -i marathon.
        use_backend marathon if host_marathon

        acl host_chronos hdr_beg(host) -i chronos.
        use_backend chronos if host_chronos
        {{ $acls := .Acls }}{{ $backendrules := .BackendRules }}{{ $services := .Services }}
        {{ range $index, $app := .Apps }} {{ if hasKey $services $app.Id }} {{ $service := getService $services $app.Id }}
        acl {{ $app.EscapedId }}-aclrule {{ $service.Acl}}
        use_backend {{ $app.EscapedId }}-cluster if {{ $app.EscapedId }}-aclrule
        {{ else }}
        {{ if $app.Env.HTTP_PREFIX }}{{ $aclprefix := replaceFwdSlashes $app.Env.HTTP_PREFIX }}
        {{ addAcl $acls (print $aclprefix "-aclrule path_beg -i " $app.Env.HTTP_PREFIX) }}
        #acl {{ $aclprefix }}-aclrule path_beg -i {{ $app.Env.HTTP_PREFIX }}
        {{ addBackendRule $backendrules (print $app.EscapedId "-cluster") (print $aclprefix "-aclrule") }}
        #use_backend {{ $app.EscapedId }}-cluster if {{ $aclprefix }}-aclrule

        {{ if and $app.Env.ENABLE_VERSION_AFFINITY (not $app.Env.ENABLE_SESSION_AFFINITY) }}{{ $versionhash := getVersionHash $app.EscapedId $app.Env.ENABLE_VERSION_AFFINITY }}
        {{ addAcl $acls (print $app.EscapedId "-" $versionhash "-aclrule hdr_reg(Cookie) VERSIONID=" $versionhash) }}
        #acl {{ $app.EscapedId }}-{{ $versionhash }}-aclrule hdr_reg(Cookie) VERSIONID={{ $versionhash }}
        {{ addBackendRule $backendrules (print $app.EscapedId "-" $versionhash "-cluster") (print $aclprefix "-aclrule " $app.EscapedId "-" $versionhash "-aclrule") }}
        #use_backend {{ $app.EscapedId }}-{{ $versionhash }}-cluster if {{ $aclprefix }}-aclrule {{ $app.EscapedId }}-{{ $versionhash }}-aclrule
        {{ end }}
        {{ else }}
        {{ addAcl $acls (print $app.EscapedId "-aclrule path_beg -i " $app.Id) }}
        #acl {{ $app.EscapedId }}-aclrule path_beg -i {{ $app.Id }}
        {{ addBackendRule $backendrules (print $app.EscapedId "-cluster") (print $app.EscapedId "-aclrule") }}
        #use_backend {{ $app.EscapedId }}-cluster if {{ $app.EscapedId }}-aclrule

        {{ if and $app.Env.ENABLE_VERSION_AFFINITY (not $app.Env.ENABLE_SESSION_AFFINITY) }}{{ $versionhash := getVersionHash $app.EscapedId $app.Env.ENABLE_VERSION_AFFINITY }}
        {{ addAcl $acls (print $app.EscapedId "-" $versionhash "-aclrule hdr_reg(Cookie) VERSIONID=" $versionhash) }}
        #acl {{ $app.EscapedId }}-{{ $versionhash }}-aclrule hdr_reg(Cookie) VERSIONID={{ $versionhash }}
        {{ addBackendRule $backendrules (print $app.EscapedId "-" $versionhash "-cluster") (print $app.EscapedId "-aclrule " $app.EscapedId "-" $versionhash "-aclrule") }}
        #use_backend {{ $app.EscapedId }}-{{ $versionhash }}-cluster if {{ $app.EscapedId }}-aclrule {{ $app.EscapedId }}-{{ $versionhash }}-aclrule
        {{ end }}
        {{ end }}

        {{ end }} {{ end }}

        # acls{{ range $acl, $v := .Acls }}
        acl {{ $acl }}{{ end }}

        # backend usage rules {{ range $aclrule, $backend := .BackendRules }}
        use_backend {{ $backend }} if {{ $aclrule }}{{ end }}

        stats enable
        # CHANGE: Your stats credentials
        stats auth admin:admin
        stats uri /haproxy_stats

{{ range $index, $app := .Apps }}

# Begin Backend section for {{ $app.EscapedId }}
# Begin Tcp ports for {{ $app.EscapedId }} {{ range $external_port, $task_port := $app.TcpPorts }}
listen {{ $app.EscapedId }}-cluster-tcp-{{ $external_port }} :{{ $external_port }}
        mode tcp
        option tcplog
        balance roundrobin
        {{ range $page, $task := $app.Tasks }}
        server {{ $app.EscapedId}}-{{ $task.Host }}-{{ $external_port }} {{ $task.Host }}:{{ getTaskPort $task.Ports $task_port }} {{ end }} {{ end }}
# End Tcp ports for {{ $app.EscapedId }}

backend {{ $app.EscapedId }}-cluster{{ if $app.HealthCheckPath }}
        option httpchk GET {{ $app.HealthCheckPath }}
        {{ end }}
        balance leastconn
        option httpclose
        option forwardfor
        {{ if $app.Env.ENABLE_SESSION_AFFINITY }}
        cookie SERVERID insert indirect nocache
        {{ else if $app.Env.ENABLE_VERSION_AFFINITY }}{{ $versionhash := getVersionHash $app.EscapedId $app.Env.ENABLE_VERSION_AFFINITY }}
        http-request set-header Cookie VERSIONID={{ $versionhash }}
        {{ end }}
        # reqrep ^([^\ ]*\ ){{ $app.Id }}\/?(.*) \1\\/\2{{ if $app.Env.HTTP_PORT }} {{ range $page, $task := .Tasks }}
        {{ if $app.Env.ENABLE_SESSION_AFFINITY }}{{ $serverhash := getServerHash $app.EscapedId $task.Host $task.Port }}
        server {{ $serverhash }} {{ $task.Host }}:{{ $task.Port }} check cookie {{ $serverhash }}{{ if $app.HealthCheckPath }} check{{ end }}
        {{ else }}server {{ $app.EscapedId}}-{{ $task.Host }}-{{ getTaskPort $task.Ports $app.Env.HTTP_PORT }} {{ $task.Host }}:{{ getTaskPort $task.Ports $app.Env.HTTP_PORT }}{{ if $app.HealthCheckPath }} check{{ end }}
        {{ end }}{{ end }}{{ end }}{{ if and $app.Env.ENABLE_VERSION_AFFINITY (not $app.Env.ENABLE_SESSION_AFFINITY) }}{{ $versionhash := getVersionHash $app.EscapedId $app.Env.ENABLE_VERSION_AFFINITY }}
# Version specific backend - {{ $versionhash }} ({{ $app.Env.ENABLE_VERSION_AFFINITY }})
backend {{ $app.EscapedId }}-{{ $versionhash }}-cluster{{ if $app.HealthCheckPath }}
        option httpchk GET {{ $app.HealthCheckPath }}
        {{ end }}
        balance leastconn
        option httpclose
        option forwardfor

        http-request set-header Cookie VERSIONID={{ $versionhash }}

        # reqrep ^([^\ ]*\ ){{ $app.Id }}\/?(.*) \1\\/\2{{ if $app.Env.HTTP_PORT }} {{ range $page, $task := .Tasks }}
        server {{ $app.EscapedId}}-{{ $task.Host }}-{{ getTaskPort $task.Ports $app.Env.HTTP_PORT }} {{ $task.Host }}:{{ getTaskPort $task.Ports $app.Env.HTTP_PORT }}{{ if $app.HealthCheckPath }} check{{ end }}
        {{ end }}{{ end }}{{ end }}
# End Backend section for {{ $app.EscapedId }} {{ end }}

{% endraw %}
# Begin Backend section for masters
backend mesos
        mode http
        balance roundrobin
        option httpclose
        option forwardfor
        option httpchk /master/state.json
        http-check expect string elected_time
        timeout check 10s
        {% for host in groups['masters'] -%}
        server {{ host }}-5050 {{ host }}:5050 check inter 10s fall 1 rise 3
        {% endfor %}

backend marathon
        mode http
        balance roundrobin
        option httpclose
        option forwardfor
        option httpchk /ping
        timeout check 10s
        {% for host in groups['marathon_servers'] -%}
        server {{ host }}-8080 {{ host }}:8080 check inter 10s fall 1 rise 3
        {% endfor %}

backend chronos
        mode http
        balance roundrobin
        option httpclose
        option forwardfor
        option httpchk /ping
        timeout check 10s
        {% for host in groups['chronos_servers'] -%}
        server {{ host }}-4400 {{ host }}:4400 check inter 10s fall 1 rise 3
        {% endfor %}
# End Backend section for masters
{% raw %}

##
## map service ports of marathon apps
## ( see https://mesosphere.github.io/marathon/docs/service-discovery-load-balancing.html#ports-assignment ))
## to haproxy frontend port
##
## {{ range $index, $app := .Apps }}
## listen {{ $app.EscapedId }}_{{ $app.ServicePort }}
##   bind *:{{ $app.ServicePort }}
##   mode http
##   {{ if $app.HealthCheckPath }}
##   # option httpchk GET {{ $app.HealthCheckPath }}
##   {{ end }}
##   balance leastconn
##   option forwardfor
##         {{ range $page, $task := .Tasks }}
##         server {{ $app.EscapedId}}-{{ $task.Host }}-{{ $task.Port }} {{ $task.Host }}:{{ $task.Port }} {{ if $app.HealthCheckPath }} check inter 30000 {{ end }} {{ end }}
## {{ end }}
{%- endraw -%}
